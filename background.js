const PRODUCT_ID="PQmFs39D1zx4wnYcc-aazQ==",ONE_DAY=864e5;async function verifyStoredLicense(e=!1){const{license:t}=await chrome.storage.local.get("license");if(!t?.key)return false;if(!e&&Date.now()-(t.lastCheck||0)<ONE_DAY)return!t.invalid;

  try{
    // Simple verification check to determine if license is valid
    const response = await fetch("https://api.gumroad.com/v2/licenses/verify", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        product_id: PRODUCT_ID,
        license_key: t.key
      })
    });
    
    const data = await response.json();
    
    // Check if license is valid (not refunded, not expired, etc)
    const isValid = data.success && 
                    !data.purchase.refunded && 
                    !data.purchase.chargebacked && 
                    (!data.purchase.ended && !data.purchase.subscription_cancelled_at);
    
    // Update license state
    await chrome.storage.local.set({
      license: {
        ...t,
        lastCheck: Date.now(),
        invalid: !isValid,
        invalidReason: !isValid ? 'invalid_license' : null
      }
    });
    
    return isValid;
  } catch(error) {
    console.error('License verification error:', error);
    // If there's a network error, don't invalidate the license
    return !t.invalid;
  }
}(async()=>{await verifyStoredLicense(!0)})();

// Auto-open popup on install if no license
chrome.runtime.onInstalled.addListener(() => {
  chrome.storage.local.get('license', ({license}) => {
    if (!license || license.invalid) {
      chrome.action.openPopup();
    }
  });
});

let automationState={version:"1.0.0",isRunning:!1,windowId:null,currentFile:null,files:[],settings:null,totalFiles:0,processedFiles:[]},isProcessingFile=!1,activeProgressTabId=null,notificationState={completionNotificationShown:!1,completionTimestamp:null,isAutomationTrulyComplete:!1,lastQueueLength:0};function resetNotificationState(){notificationState={completionNotificationShown:!1,completionTimestamp:null,isAutomationTrulyComplete:!1,lastQueueLength:0}}async function ensureNotificationPermissions(){try{return new Promise(e=>{chrome.permissions.contains({permissions:["notifications"]},t=>{e(!!t)})})}catch(t){return!1}}function createFileObject(t,e){return{index:e,filename:t.filename||"",blobUrl:t.blobUrl||null,base64:t.base64||null,status:"pending"}}function isValidFileObject(t){return t&&"object"==typeof t&&"string"==typeof t.filename&&"number"==typeof t.index&&"string"==typeof t.status&&(void 0!==t.blobUrl||void 0!==t.base64)}function createCleanState(){return{version:"1.0.0",isRunning:!1,windowId:null,currentFile:null,files:[],settings:null,totalFiles:0,processedFiles:[]}}async function safeStorageGet(t){return new Promise((e,a)=>{try{chrome.storage.local.get(t,t=>{chrome.runtime.lastError?a(chrome.runtime.lastError):e(t)})}catch(t){a(t)}})}async function safeStorageSet(a){return new Promise((t,e)=>{try{chrome.storage.local.set(a,()=>{chrome.runtime.lastError?e(chrome.runtime.lastError):t()})}catch(t){e(t)}})}async function safeStorageRemove(a){return new Promise((t,e)=>{try{chrome.storage.local.remove(a,()=>{chrome.runtime.lastError?e(chrome.runtime.lastError):t()})}catch(t){e(t)}})}async function verifyNotificationPermissionSilently(){return new Promise(e=>{try{var t="snap-perm-test-"+Date.now();chrome.notifications.create(t,{type:"basic",iconUrl:chrome.runtime.getURL("Icon.png"),title:"",message:"",priority:-2,silent:!0,requireInteraction:!1},t=>{chrome.notifications.clear(t),e(!0)})}catch(t){e(!1)}})}async function safeCreateNotification(t,e,a=1,o=0){try{if(!await verifyNotificationPermissionSilently())return!1;const i="snap-notification-"+Date.now()+"-"+Math.random().toString(36).substr(2,9);return await chrome.notifications.create(i,{type:"basic",iconUrl:chrome.runtime.getURL("Icon.png"),title:t,message:e,priority:a,requireInteraction:0===o&&1<a}),0<o&&setTimeout(()=>{chrome.notifications.clear(i)},1e3*o),!0}catch(t){return!1}}async function handleStartAutomation(t){try{if(resetNotificationState(),await ensureNotificationPermissions(),automationState.isRunning){if(automationState.windowId)try{await chrome.windows.get(automationState.windowId)||(console.log(""),automationState=createCleanState())}catch(t){console.log(""),automationState=createCleanState(),await safeStorageRemove(["automationState","automationQueue","automationFiles"])}else console.log(""),automationState=createCleanState(),await safeStorageRemove(["automationState","automationQueue","automationFiles"]);if(automationState.isRunning)throw new Error("Automation already running")}if(!Array.isArray(t?.files)||0===t.files.length)throw new Error("Invalid request data - missing files");var e=t.files.map((t,e)=>createFileObject(t,e)),a=e[0];if(!isValidFileObject(a))throw new Error("Invalid first file structure");var o={...createCleanState(),isRunning:!0,files:e,currentFile:a,settings:{...t.settings||{},useNativeUploader:!0===t.settings?.useNativeUploader},totalFiles:e.length},i=(console.log("",JSON.stringify({useNativeUploader:o.settings?.useNativeUploader,requestSettingsValue:t.settings?.useNativeUploader})),{settings:t.settings||{},remainingFiles:e.slice(1),totalFiles:e.length,currentIndex:0,currentFile:a,processedFiles:[]}),s=await chrome.windows.create({url:"https://merch.amazon.com/designs/new?Snap=0-"+encodeURIComponent(a.filename),type:"normal",state:"maximized"});o.windowId=s.id,await safeStorageRemove(["automationState","automationQueue"]),await safeStorageSet({automationState:o,automationQueue:i,automationFiles:{[a.filename]:a.blobUrl||a.base64,...Object.fromEntries(e.slice(1).map(t=>[t.filename,t.blobUrl||t.base64]))}}),automationState=o;try{await safeCreateNotification("Snap Automation Started",`Processing ${o.totalFiles} files`,1)}catch(t){}return{success:!0}}catch(t){throw t}}async function requireLicense(){return await verifyStoredLicense()}const originalHandleStartAutomation = handleStartAutomation;handleStartAutomation = async function(request,...rest){if(!await requireLicense())throw new Error("License required");return originalHandleStartAutomation(request,...rest)};function revokeBlobUrl(t){if(t&&"string"==typeof t&&t.startsWith("blob:"))try{URL.revokeObjectURL(t)}catch(t){}}async function handleMarkTabCompleted(t,e){try{var a,o=await safeStorageGet(["automationState","automationQueue"]);if(o?.automationState)return o.automationState.currentFile&&o.automationState.currentFile.filename===t.filename?(o.automationState.currentFile.blobUrl&&revokeBlobUrl(o.automationState.currentFile.blobUrl),await safeStorageSet({automationState:a={...o.automationState,currentFile:{...o.automationState.currentFile,status:"completed",completedAt:Date.now(),completionStatus:t.status||"completed",error:t.error||null}}}),automationState=a,{success:!0}):{success:!1,error:"File mismatch"};throw new Error("Missing automation state")}catch(t){return{success:!1,error:t.message}}}async function handleProcessNextFile(t,e){try{var a=await safeStorageGet(["automationState"]);if(a?.automationState?.currentFile)if("completed"!==a.automationState.currentFile.status){let t=0;for(;t<20;){if(await new Promise(t=>setTimeout(t,1e3)),"completed"===(await safeStorageGet(["automationState"]))?.automationState?.currentFile?.status)break;if(20<=++t)return{success:!1,error:"Current file not completed after maximum wait time"}}}const d=await safeStorageGet(["automationQueue","automationState","automationFiles"]);if(!d?.automationQueue||!d?.automationState||!d?.automationFiles)throw new Error("Missing automation data");if("completed"!==d.automationState.currentFile?.status)return{success:!1,error:"Current file not completed after verification"};var o,i={...createCleanState(),...d.automationState,isRunning:!0},s=Array.isArray(d.automationQueue.remainingFiles)?d.automationQueue.remainingFiles.map(t=>({index:t.index||0,filename:t.filename||"",blobUrl:d.automationFiles[t.filename]||null,status:t.status||"pending"})):[];if(notificationState.lastQueueLength=s.length,i.currentFile){const g={...i.currentFile,status:"completed"},{[g.filename]:f,...S}=(g.blobUrl&&revokeBlobUrl(g.blobUrl),i.processedFiles||(i.processedFiles=[]),i.processedFiles.some(t=>t.filename===g.filename)||i.processedFiles.push(g),d.automationFiles);await safeStorageSet({automationFiles:S})}if(0===s.length)return notificationState.isAutomationTrulyComplete=!0,notificationState.completionTimestamp=Date.now(),o={...i,isRunning:!1,currentFile:i.currentFile?{...i.currentFile,status:"completed"}:null},await Promise.all([safeStorageRemove(["automationQueue","automationFiles"]),safeStorageSet({automationState:o})]),automationState=o,await completeAutomation(),{success:!0,completed:!0};var r=s[0],n=(d.automationQueue.currentIndex||0)+1,c={index:n,filename:r.filename,blobUrl:d.automationFiles[r.filename]||null,status:"pending"},u={settings:d.automationQueue.settings||{},remainingFiles:s.slice(1),totalFiles:d.automationQueue.totalFiles||s.length+1,currentIndex:n,currentFile:c,processedFiles:i.processedFiles||[]},l={...i,isRunning:!0,currentFile:c},m=(await safeStorageSet({automationQueue:u,automationState:l}),automationState=l,await new Promise(t=>setTimeout(t,1e3)),await chrome.tabs.create({windowId:l.windowId,url:`https://merch.amazon.com/designs/new?Snap=${n}-`+encodeURIComponent(c.filename),active:!0}));if(activeProgressTabId=m.id,e?.tab?.id)try{await chrome.tabs.sendMessage(e.tab.id,{action:"updateAutomationProgress",isTabCompleted:!0,forceHide:!0})}catch(t){}return{success:!0}}catch(t){throw t}}async function completeAutomation(){try{notificationState.isAutomationTrulyComplete=!0,notificationState.completionTimestamp=Date.now(),automationState.isRunning=!1,automationState?.files&&Array.isArray(automationState.files)&&automationState.files.forEach(t=>{t.blobUrl&&revokeBlobUrl(t.blobUrl)});var t,e,a={...createCleanState(),windowId:automationState?.windowId||null,currentFile:automationState?.currentFile?{...automationState.currentFile,status:"completed"}:null,files:Array.isArray(automationState?.files)?automationState.files.map(t=>({...t})):[],settings:automationState?.settings||null,totalFiles:automationState?.totalFiles||0,processedFiles:Array.isArray(automationState?.processedFiles)?automationState.processedFiles.map(t=>({...t})):[]};await safeStorageSet({automationState:a}),automationState=a;try{if(!notificationState.completionNotificationShown&&notificationState.isAutomationTrulyComplete&&(await safeCreateNotification("Snap Automation Complete",`All ${a.processedFiles.length} files have been processed successfully!`,2,5),notificationState.completionNotificationShown=!0),activeProgressTabId)try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"playCompletionSound",isFinalTab:!0})}catch(t){automationState&&automationState.windowId&&(e=await chrome.tabs.query({windowId:automationState.windowId,active:!0}))&&0<e.length&&await chrome.tabs.sendMessage(e[0].id,{action:"playCompletionSound",isFinalTab:!0})}else automationState&&automationState.windowId&&(t=await chrome.tabs.query({windowId:automationState.windowId,active:!0}))&&0<t.length&&await chrome.tabs.sendMessage(t[0].id,{action:"playCompletionSound",isFinalTab:!0})}catch(t){}try{if(activeProgressTabId){var o=[{status:"Uploading...",index:0},{status:"Processing Products",index:1},{status:"Processing Design",index:2},{status:"Actions: Text Swap",index:18},{status:"Actions: Copy EN to All",index:19},{status:"Actions: Save to Drafts",index:20},{status:"Completed",index:21}];for(let t=0;t<o.length;t++){var i=o[t],s=t===o.length-1,r={status:i.status,statusIndex:i.index,totalStatuses:22,isCompleted:s};s&&(r.forceExact100Percent=!0);try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"updateAutomationProgress",status:i.status,currentFile:a.totalFiles,totalFiles:a.totalFiles,completed:s,isTabCompleted:!1,updateProgressOnly:!0,updateProgressBar:s,forceProgressUpdate:s,forceExact100Percent:s,statusInfo:r})}catch(t){break}s?await new Promise(t=>setTimeout(t,1e3)):await new Promise(t=>setTimeout(t,500))}await new Promise(t=>setTimeout(t,3e3));try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"updateAutomationProgress",isTabCompleted:!0,forceHide:!0})}catch(t){}activeProgressTabId=null}}catch(t){}await new Promise(t=>setTimeout(t,5e3));try{await safeStorageRemove(["automationQueue"]),(await safeStorageGet(["automationFiles"])).automationFiles&&await safeStorageRemove(["automationFiles"]),setTimeout(()=>{notificationState.isAutomationTrulyComplete&&resetNotificationState()},12e4)}catch(t){}return{success:!0,completed:!0}}catch(t){throw t}}function handleExtractDesignBase64(t){return chrome.scripting.executeScript({target:{tabId:t.tab.id},func:()=>{try{var t,e=document.querySelector("img.artwork.ng-star-inserted");return e?((t=document.createElement("canvas")).width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),{success:!0,dataURL:t.toDataURL("image/png")}):{success:!1,error:"Design element not found"}}catch(t){return{success:!1,error:t.message}}},world:"MAIN"},t=>chrome.runtime.lastError?{success:!1,error:chrome.runtime.lastError.message}:t&&t[0]&&t[0].result.success?{success:!0,dataURL:t[0].result.dataURL}:{success:!1,error:t[0]?.result?.error||"Unknown error"})}(async()=>{try{await ensureNotificationPermissions()}catch(t){}})(),chrome.runtime.onMessage.addListener((c,u,e)=>{return(async()=>{try{switch(c.action){case"startAutomation":return await handleStartAutomation(c),{success:!0};case"getAutomationState":try{var t,e=await safeStorageGet(["automationFiles"]),a={...automationState};return a.currentFile&&e.automationFiles&&(t=a.currentFile.filename)&&e.automationFiles[t]&&(a.currentFile={...a.currentFile,blobUrl:e.automationFiles[t]}),{success:!0,state:a}}catch(t){return{success:!0,state:automationState}}case"processNextFile":return await handleProcessNextFile(c,u),{success:!0};case"markTabCompleted":return await handleMarkTabCompleted(c,u),{success:!0};case"playCompletionSound":try{var o,i=!0===c.isLastFile||!0===c.isFinalTab,s=Date.now(),r=notificationState.completionTimestamp&&s-notificationState.completionTimestamp<6e4;!i||notificationState.completionNotificationShown||r?i&&notificationState.completionNotificationShown:(notificationState.isAutomationTrulyComplete=!0,notificationState.completionTimestamp=s,await safeCreateNotification("Snap Automation Complete","All files have been processed successfully!",2,5),notificationState.completionNotificationShown=!0),activeProgressTabId?await chrome.tabs.sendMessage(activeProgressTabId,{action:"playCompletionSound",isFinalTab:i}):automationState&&automationState.windowId&&(o=await chrome.tabs.query({windowId:automationState.windowId,active:!0}))&&0<o.length&&await chrome.tabs.sendMessage(o[0].id,{action:"playCompletionSound",isFinalTab:i})}catch(t){}return{success:!0};case"updateAutomationProgress":try{if(activeProgressTabId=(activeProgressTabId=c.isTabCompleted&&u.tab&&u.tab.id===activeProgressTabId?null:activeProgressTabId)||c.isTabCompleted||!u.tab?activeProgressTabId:u.tab.id)try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"updateAutomationProgress",status:c.status,filename:c.filename,currentFile:c.currentFile,totalFiles:c.totalFiles,isTabCompleted:c.isTabCompleted,updateProgressOnly:c.updateProgressOnly,updateProgressBar:c.updateProgressBar,forceProgressUpdate:c.forceProgressUpdate,queueProgress:c.queueProgress,statusInfo:c.statusInfo,completed:c.completed})}catch(t){activeProgressTabId=null}return{success:!0}}catch(t){return{success:!1,error:t.message}}case"setActiveProgressTab":if(u.tab){if(activeProgressTabId&&activeProgressTabId!==u.tab.id)try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"updateAutomationProgress",isTabCompleted:!0,forceHide:!0})}catch(t){}return{success:!0,activeProgressTabId:activeProgressTabId=u.tab.id,automationState:automationState}}return{success:!1,error:"No tab ID provided"};case"hideAllProgressUI":try{if(activeProgressTabId){try{await chrome.tabs.sendMessage(activeProgressTabId,{action:"updateAutomationProgress",isTabCompleted:!0,forceHide:!0})}catch(t){}activeProgressTabId=null}else for(const n of await chrome.tabs.query({}))try{await chrome.tabs.sendMessage(n.id,{action:"updateAutomationProgress",isTabCompleted:!0,forceHide:!0})}catch(t){}return{success:!0,message:"Progress UI hidden"}}catch(t){return{success:!1,error:t.message}}case"extractDesignBase64":return await handleExtractDesignBase64(u);case"showErrorNotification":try{return await safeCreateNotification("Snap Automation Error",`Error processing ${c.filename||"file"}: `+(c.error||"Unknown error"),2),{success:!0}}catch(t){return{success:!1,error:t.message}}default:return{success:!1,error:"Unknown action"}}}catch(t){return{success:!1,error:t.message}}})().then(t=>{try{e(t)}catch(t){}}),!0}),chrome.windows.onRemoved.addListener(async t=>{if(console.log(),t===automationState.windowId){console.log(""),automationState?.files&&Array.isArray(automationState.files)&&automationState.files.forEach(t=>{t.blobUrl&&revokeBlobUrl(t.blobUrl)}),automationState=createCleanState(),isProcessingFile=!1,activeProgressTabId=null,resetNotificationState();try{await safeStorageRemove(["automationState","automationQueue","automationFiles"]),console.log("")}catch(t){console.error("")}}}),chrome.tabs.onUpdated.addListener((t,e,a)=>{"complete"!==e.status||!a.url?.includes("merch.amazon.com/designs/new")||isProcessingFile||chrome.storage.local.get(["automationState","automationQueue"],async t=>{try{t.automationState?.isRunning&&t.automationState.windowId===a.windowId&&(isProcessingFile=!0,await new Promise(t=>setTimeout(t,2e3)),chrome.scripting.executeScript({target:{tabId:a.id},func:async()=>{try{await new Promise((e,a)=>{let o=0;const i=()=>{o++;var t=document.querySelector(".snap-upload-container");t?e(t):30<=o?a(new Error("Upload container not found after 15 seconds")):setTimeout(i,500)};i()});return await new Promise(t=>setTimeout(t,2e3)),{success:!0}}catch(t){return{success:!1,error:t.message}}}},async t=>{isProcessingFile=!1}))}catch(t){isProcessingFile=!1}})}),chrome.runtime.onSuspend.addListener(()=>{try{resetNotificationState(),isProcessingFile=!1,activeProgressTabId=null}catch(t){}});